services:
  global-db:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: vetchium_global
      POSTGRES_USER: vetchium
      POSTGRES_PASSWORD: vetchium_dev
    volumes:
      - global-db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_global"]
      interval: 5s
      timeout: 5s
      retries: 5

  regional-db-ind1:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: vetchium_ind1
      POSTGRES_USER: vetchium
      POSTGRES_PASSWORD: vetchium_dev
    volumes:
      - regional-db-ind1-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_ind1"]
      interval: 5s
      timeout: 5s
      retries: 5

  regional-db-usa1:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: vetchium_usa1
      POSTGRES_USER: vetchium
      POSTGRES_PASSWORD: vetchium_dev
    volumes:
      - regional-db-usa1-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_usa1"]
      interval: 5s
      timeout: 5s
      retries: 5

  regional-db-deu1:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: vetchium_deu1
      POSTGRES_USER: vetchium
      POSTGRES_PASSWORD: vetchium_dev
    volumes:
      - regional-db-deu1-data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_deu1"]
      interval: 5s
      timeout: 5s
      retries: 5

  migrate-global:
    build:
      context: ./api-server
      dockerfile: Dockerfile.migrate
    depends_on:
      global-db:
        condition: service_healthy
    command: ["-dir", "/migrations/global", "postgres", "postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable", "up"]

  migrate-ind1:
    build:
      context: ./api-server
      dockerfile: Dockerfile.migrate
    depends_on:
      regional-db-ind1:
        condition: service_healthy
    command: ["-dir", "/migrations/regional", "postgres", "postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable", "up"]

  migrate-usa1:
    build:
      context: ./api-server
      dockerfile: Dockerfile.migrate
    depends_on:
      regional-db-usa1:
        condition: service_healthy
    command: ["-dir", "/migrations/regional", "postgres", "postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable", "up"]

  migrate-deu1:
    build:
      context: ./api-server
      dockerfile: Dockerfile.migrate
    depends_on:
      regional-db-deu1:
        condition: service_healthy
    command: ["-dir", "/migrations/regional", "postgres", "postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable", "up"]

  api-server-ind1:
    build:
      context: .
      dockerfile: api-server/Dockerfile
    depends_on:
      migrate-global:
        condition: service_completed_successfully
      migrate-ind1:
        condition: service_completed_successfully
      migrate-usa1:
        condition: service_completed_successfully
      migrate-deu1:
        condition: service_completed_successfully
    environment:
      REGION: ind1
      LOG_LEVEL: DEBUG
      GLOBAL_DB_CONN: postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable
      REGIONAL_DB_IND1_CONN: postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable
      REGIONAL_DB_USA1_CONN: postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable
      REGIONAL_DB_DEU1_CONN: postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable
  api-server-usa1:
    build:
      context: .
      dockerfile: api-server/Dockerfile
    depends_on:
      migrate-global:
        condition: service_completed_successfully
      migrate-ind1:
        condition: service_completed_successfully
      migrate-usa1:
        condition: service_completed_successfully
      migrate-deu1:
        condition: service_completed_successfully
    environment:
      REGION: usa1
      LOG_LEVEL: DEBUG
      GLOBAL_DB_CONN: postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable
      REGIONAL_DB_IND1_CONN: postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable
      REGIONAL_DB_USA1_CONN: postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable
      REGIONAL_DB_DEU1_CONN: postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable
  api-server-deu1:
    build:
      context: .
      dockerfile: api-server/Dockerfile
    depends_on:
      migrate-global:
        condition: service_completed_successfully
      migrate-ind1:
        condition: service_completed_successfully
      migrate-usa1:
        condition: service_completed_successfully
      migrate-deu1:
        condition: service_completed_successfully
    environment:
      REGION: deu1
      LOG_LEVEL: DEBUG
      GLOBAL_DB_CONN: postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable
      REGIONAL_DB_IND1_CONN: postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable
      REGIONAL_DB_USA1_CONN: postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable
      REGIONAL_DB_DEU1_CONN: postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable

  api-lb:
    image: nginx:alpine
    volumes:
      - ./nginx/api-lb.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
    depends_on:
      - api-server-ind1
      - api-server-usa1
      - api-server-deu1

  hub-ui:
    build:
      context: .
      dockerfile: hub-ui/Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - api-lb

volumes:
  global-db-data:
  regional-db-ind1-data:
  regional-db-usa1-data:
  regional-db-deu1-data:
