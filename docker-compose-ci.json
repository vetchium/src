{
	"services": {
		"global-db": {
			"image": "postgres:17-alpine",
			"environment": {
				"POSTGRES_DB": "vetchium_global",
				"POSTGRES_USER": "vetchium",
				"POSTGRES_PASSWORD": "vetchium_dev"
			},
			"volumes": ["global-db-data:/var/lib/postgresql/data"],
			"ports": ["5432:5432"],
			"healthcheck": {
				"test": ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_global"],
				"interval": "5s",
				"timeout": "5s",
				"retries": 5
			}
		},
		"regional-db-ind1": {
			"image": "postgres:17-alpine",
			"environment": {
				"POSTGRES_DB": "vetchium_ind1",
				"POSTGRES_USER": "vetchium",
				"POSTGRES_PASSWORD": "vetchium_dev"
			},
			"volumes": ["regional-db-ind1-data:/var/lib/postgresql/data"],
			"ports": ["5433:5432"],
			"healthcheck": {
				"test": ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_ind1"],
				"interval": "5s",
				"timeout": "5s",
				"retries": 5
			}
		},
		"regional-db-usa1": {
			"image": "postgres:17-alpine",
			"environment": {
				"POSTGRES_DB": "vetchium_usa1",
				"POSTGRES_USER": "vetchium",
				"POSTGRES_PASSWORD": "vetchium_dev"
			},
			"volumes": ["regional-db-usa1-data:/var/lib/postgresql/data"],
			"ports": ["5434:5432"],
			"healthcheck": {
				"test": ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_usa1"],
				"interval": "5s",
				"timeout": "5s",
				"retries": 5
			}
		},
		"regional-db-deu1": {
			"image": "postgres:17-alpine",
			"environment": {
				"POSTGRES_DB": "vetchium_deu1",
				"POSTGRES_USER": "vetchium",
				"POSTGRES_PASSWORD": "vetchium_dev"
			},
			"volumes": ["regional-db-deu1-data:/var/lib/postgresql/data"],
			"ports": ["5435:5432"],
			"healthcheck": {
				"test": ["CMD-SHELL", "pg_isready -U vetchium -d vetchium_deu1"],
				"interval": "5s",
				"timeout": "5s",
				"retries": 5
			}
		},
		"localstack": {
			"image": "localstack/localstack",
			"environment": {
				"SERVICES": "s3",
				"DEBUG": "0"
			},
			"ports": ["4566:4566"],
			"healthcheck": {
				"test": [
					"CMD-SHELL",
					"curl -f http://localhost:4566/_localstack/health"
				],
				"interval": "5s",
				"timeout": "5s",
				"retries": 15
			}
		},
		"s3-init": {
			"image": "amazon/aws-cli",
			"depends_on": {
				"localstack": { "condition": "service_healthy" }
			},
			"entrypoint": ["sh", "-c"],
			"command": [
				"i=0; until aws --endpoint-url=http://localstack:4566 s3 ls s3://vetchium 2>/dev/null || aws --endpoint-url=http://localstack:4566 s3 mb s3://vetchium 2>/dev/null; do i=$$((i+1)); [ $$i -ge 30 ] && exit 1; sleep 2; done"
			],
			"environment": {
				"AWS_ACCESS_KEY_ID": "vetchium-dev-key",
				"AWS_SECRET_ACCESS_KEY": "vetchium-dev-secret",
				"AWS_DEFAULT_REGION": "us-east-1"
			}
		},
		"mailpit": {
			"image": "axllent/mailpit:latest",
			"ports": ["8025:8025", "1025:1025"],
			"environment": {
				"MP_SMTP_AUTH_ACCEPT_ANY": "true",
				"MP_SMTP_AUTH_ALLOW_INSECURE": "true"
			}
		},
		"migrate-global": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.migrate"
			},
			"depends_on": {
				"global-db": {
					"condition": "service_healthy"
				}
			},
			"command": [
				"-dir",
				"/migrations/global",
				"postgres",
				"postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable",
				"up"
			]
		},
		"migrate-ind1": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.migrate"
			},
			"depends_on": {
				"regional-db-ind1": {
					"condition": "service_healthy"
				}
			},
			"command": [
				"-dir",
				"/migrations/regional",
				"postgres",
				"postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable",
				"up"
			]
		},
		"migrate-usa1": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.migrate"
			},
			"depends_on": {
				"regional-db-usa1": {
					"condition": "service_healthy"
				}
			},
			"command": [
				"-dir",
				"/migrations/regional",
				"postgres",
				"postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable",
				"up"
			]
		},
		"migrate-deu1": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.migrate"
			},
			"depends_on": {
				"regional-db-deu1": {
					"condition": "service_healthy"
				}
			},
			"command": [
				"-dir",
				"/migrations/regional",
				"postgres",
				"postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable",
				"up"
			]
		},
		"seed-global": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.seed"
			},
			"depends_on": {
				"migrate-global": {
					"condition": "service_completed_successfully"
				}
			},
			"command": [
				"postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable",
				"-f",
				"/seed/global.sql"
			]
		},
		"seed-ind1": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.seed"
			},
			"depends_on": {
				"migrate-ind1": {
					"condition": "service_completed_successfully"
				}
			},
			"command": [
				"postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable",
				"-f",
				"/seed/regional.sql"
			]
		},
		"seed-usa1": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.seed"
			},
			"depends_on": {
				"migrate-usa1": {
					"condition": "service_completed_successfully"
				}
			},
			"command": [
				"postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable",
				"-f",
				"/seed/regional.sql"
			]
		},
		"seed-deu1": {
			"build": {
				"context": "./api-server",
				"dockerfile": "Dockerfile.seed"
			},
			"depends_on": {
				"migrate-deu1": {
					"condition": "service_completed_successfully"
				}
			},
			"command": [
				"postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable",
				"-f",
				"/seed/regional.sql"
			]
		},
		"global-service": {
			"build": {
				"context": ".",
				"dockerfile": "api-server/Dockerfile.global-service"
			},
			"depends_on": {
				"migrate-global": {
					"condition": "service_completed_successfully"
				},
				"seed-global": {
					"condition": "service_completed_successfully"
				},
				"mailpit": {
					"condition": "service_started"
				},
				"s3-init": {
					"condition": "service_completed_successfully"
				}
			},
			"environment": {
				"LOG_LEVEL": "DEBUG",
				"GLOBAL_DB_CONN": "postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable",
				"SMTP_HOST": "mailpit",
				"SMTP_PORT": "1025",
				"SMTP_FROM_ADDRESS": "noreply@vetchium.com",
				"SMTP_FROM_NAME": "Vetchium",
				"EMAIL_WORKER_POLL_INTERVAL": "1s",
				"ADMIN_TFA_TOKEN_EXPIRY": "15s",
				"ADMIN_SESSION_TOKEN_EXPIRY": "30s",
				"ADMIN_INVITATION_TOKEN_EXPIRY": "30s",
				"ADMIN_PASSWORD_RESET_TOKEN_EXPIRY": "30s",
				"ADMIN_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"ADMIN_SESSION_CLEANUP_INTERVAL": "5s",
				"ADMIN_PASSWORD_RESET_TOKEN_CLEANUP_INTERVAL": "5s",
				"HUB_SIGNUP_TOKEN_CLEANUP_INTERVAL": "5s",
				"ORG_SIGNUP_TOKEN_CLEANUP_INTERVAL": "5s",
				"AGENCY_SIGNUP_TOKEN_CLEANUP_INTERVAL": "5s",
				"ADMIN_UI_URL": "http://localhost:3001",
				"CORS_ALLOWED_ORIGINS": "*",
				"S3_ENDPOINT": "http://localstack:4566",
				"S3_ACCESS_KEY_ID": "vetchium-dev-key",
				"S3_SECRET_ACCESS_KEY": "vetchium-dev-secret",
				"S3_REGION": "us-east-1",
				"S3_BUCKET": "vetchium"
			}
		},
		"regional-api-server-ind1": {
			"build": {
				"context": ".",
				"dockerfile": "api-server/Dockerfile.regional"
			},
			"depends_on": {
				"migrate-global": {
					"condition": "service_completed_successfully"
				},
				"migrate-ind1": {
					"condition": "service_completed_successfully"
				},
				"migrate-usa1": {
					"condition": "service_completed_successfully"
				},
				"migrate-deu1": {
					"condition": "service_completed_successfully"
				},
				"mailpit": {
					"condition": "service_started"
				},
				"s3-init": {
					"condition": "service_completed_successfully"
				}
			},
			"environment": {
				"REGION": "ind1",
				"ENV": "DEV",
				"LOG_LEVEL": "DEBUG",
				"GLOBAL_DB_CONN": "postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable",
				"REGIONAL_DB_CONN": "postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable",
				"INTERNAL_ENDPOINT_IND1": "http://regional-api-server-ind1:8080",
				"INTERNAL_ENDPOINT_USA1": "http://regional-api-server-usa1:8080",
				"INTERNAL_ENDPOINT_DEU1": "http://regional-api-server-deu1:8080",
				"ADMIN_TFA_TOKEN_EXPIRY": "15s",
				"ADMIN_SESSION_TOKEN_EXPIRY": "30s",
				"HUB_TFA_TOKEN_EXPIRY": "15s",
				"HUB_SESSION_TOKEN_EXPIRY": "30s",
				"HUB_SIGNUP_TOKEN_EXPIRY": "30s",
				"HUB_REMEMBER_ME_EXPIRY": "60s",
				"ORG_TFA_TOKEN_EXPIRY": "15s",
				"ORG_SESSION_TOKEN_EXPIRY": "30s",
				"ORG_SIGNUP_TOKEN_EXPIRY": "30s",
				"ORG_REMEMBER_ME_EXPIRY": "60s",
				"AGENCY_TFA_TOKEN_EXPIRY": "15s",
				"AGENCY_SESSION_TOKEN_EXPIRY": "30s",
				"AGENCY_SIGNUP_TOKEN_EXPIRY": "30s",
				"AGENCY_REMEMBER_ME_EXPIRY": "60s",
				"S3_ENDPOINT": "http://localstack:4566",
				"S3_ACCESS_KEY_ID": "vetchium-dev-key",
				"S3_SECRET_ACCESS_KEY": "vetchium-dev-secret",
				"S3_REGION": "us-east-1",
				"S3_BUCKET": "vetchium"
			}
		},
		"regional-api-server-usa1": {
			"build": {
				"context": ".",
				"dockerfile": "api-server/Dockerfile.regional"
			},
			"depends_on": {
				"migrate-global": {
					"condition": "service_completed_successfully"
				},
				"migrate-ind1": {
					"condition": "service_completed_successfully"
				},
				"migrate-usa1": {
					"condition": "service_completed_successfully"
				},
				"migrate-deu1": {
					"condition": "service_completed_successfully"
				},
				"mailpit": {
					"condition": "service_started"
				},
				"s3-init": {
					"condition": "service_completed_successfully"
				}
			},
			"environment": {
				"REGION": "usa1",
				"ENV": "DEV",
				"LOG_LEVEL": "DEBUG",
				"GLOBAL_DB_CONN": "postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable",
				"REGIONAL_DB_CONN": "postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable",
				"INTERNAL_ENDPOINT_IND1": "http://regional-api-server-ind1:8080",
				"INTERNAL_ENDPOINT_USA1": "http://regional-api-server-usa1:8080",
				"INTERNAL_ENDPOINT_DEU1": "http://regional-api-server-deu1:8080",
				"ADMIN_TFA_TOKEN_EXPIRY": "15s",
				"ADMIN_SESSION_TOKEN_EXPIRY": "30s",
				"HUB_TFA_TOKEN_EXPIRY": "15s",
				"HUB_SESSION_TOKEN_EXPIRY": "30s",
				"HUB_SIGNUP_TOKEN_EXPIRY": "30s",
				"HUB_REMEMBER_ME_EXPIRY": "60s",
				"ORG_TFA_TOKEN_EXPIRY": "15s",
				"ORG_SESSION_TOKEN_EXPIRY": "30s",
				"ORG_SIGNUP_TOKEN_EXPIRY": "30s",
				"ORG_REMEMBER_ME_EXPIRY": "60s",
				"AGENCY_TFA_TOKEN_EXPIRY": "15s",
				"AGENCY_SESSION_TOKEN_EXPIRY": "30s",
				"AGENCY_SIGNUP_TOKEN_EXPIRY": "30s",
				"AGENCY_REMEMBER_ME_EXPIRY": "60s",
				"S3_ENDPOINT": "http://localstack:4566",
				"S3_ACCESS_KEY_ID": "vetchium-dev-key",
				"S3_SECRET_ACCESS_KEY": "vetchium-dev-secret",
				"S3_REGION": "us-east-1",
				"S3_BUCKET": "vetchium"
			}
		},
		"regional-api-server-deu1": {
			"build": {
				"context": ".",
				"dockerfile": "api-server/Dockerfile.regional"
			},
			"depends_on": {
				"migrate-global": {
					"condition": "service_completed_successfully"
				},
				"migrate-ind1": {
					"condition": "service_completed_successfully"
				},
				"migrate-usa1": {
					"condition": "service_completed_successfully"
				},
				"migrate-deu1": {
					"condition": "service_completed_successfully"
				},
				"mailpit": {
					"condition": "service_started"
				},
				"s3-init": {
					"condition": "service_completed_successfully"
				}
			},
			"environment": {
				"REGION": "deu1",
				"ENV": "DEV",
				"LOG_LEVEL": "DEBUG",
				"GLOBAL_DB_CONN": "postgres://vetchium:vetchium_dev@global-db:5432/vetchium_global?sslmode=disable",
				"REGIONAL_DB_CONN": "postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable",
				"INTERNAL_ENDPOINT_IND1": "http://regional-api-server-ind1:8080",
				"INTERNAL_ENDPOINT_USA1": "http://regional-api-server-usa1:8080",
				"INTERNAL_ENDPOINT_DEU1": "http://regional-api-server-deu1:8080",
				"ADMIN_TFA_TOKEN_EXPIRY": "15s",
				"ADMIN_SESSION_TOKEN_EXPIRY": "30s",
				"HUB_TFA_TOKEN_EXPIRY": "15s",
				"HUB_SESSION_TOKEN_EXPIRY": "30s",
				"HUB_SIGNUP_TOKEN_EXPIRY": "30s",
				"HUB_REMEMBER_ME_EXPIRY": "60s",
				"ORG_TFA_TOKEN_EXPIRY": "15s",
				"ORG_SESSION_TOKEN_EXPIRY": "30s",
				"ORG_SIGNUP_TOKEN_EXPIRY": "30s",
				"ORG_REMEMBER_ME_EXPIRY": "60s",
				"AGENCY_TFA_TOKEN_EXPIRY": "15s",
				"AGENCY_SESSION_TOKEN_EXPIRY": "30s",
				"AGENCY_SIGNUP_TOKEN_EXPIRY": "30s",
				"AGENCY_REMEMBER_ME_EXPIRY": "60s",
				"S3_ENDPOINT": "http://localstack:4566",
				"S3_ACCESS_KEY_ID": "vetchium-dev-key",
				"S3_SECRET_ACCESS_KEY": "vetchium-dev-secret",
				"S3_REGION": "us-east-1",
				"S3_BUCKET": "vetchium"
			}
		},
		"regional-worker-ind1": {
			"build": {
				"context": ".",
				"dockerfile": "api-server/Dockerfile.regional-worker"
			},
			"depends_on": {
				"migrate-ind1": {
					"condition": "service_completed_successfully"
				},
				"seed-ind1": {
					"condition": "service_completed_successfully"
				},
				"mailpit": {
					"condition": "service_started"
				}
			},
			"environment": {
				"REGION": "ind1",
				"LOG_LEVEL": "DEBUG",
				"REGIONAL_DB_CONN": "postgres://vetchium:vetchium_dev@regional-db-ind1:5432/vetchium_ind1?sslmode=disable",
				"SMTP_HOST": "mailpit",
				"SMTP_PORT": "1025",
				"SMTP_FROM_ADDRESS": "noreply@vetchium.com",
				"SMTP_FROM_NAME": "Vetchium",
				"EMAIL_WORKER_POLL_INTERVAL": "1s",
				"HUB_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"HUB_SESSION_CLEANUP_INTERVAL": "5s",
				"ORG_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"ORG_SESSION_CLEANUP_INTERVAL": "5s",
				"AGENCY_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"AGENCY_SESSION_CLEANUP_INTERVAL": "5s"
			}
		},
		"regional-worker-usa1": {
			"build": {
				"context": ".",
				"dockerfile": "api-server/Dockerfile.regional-worker"
			},
			"depends_on": {
				"migrate-usa1": {
					"condition": "service_completed_successfully"
				},
				"seed-usa1": {
					"condition": "service_completed_successfully"
				},
				"mailpit": {
					"condition": "service_started"
				}
			},
			"environment": {
				"REGION": "usa1",
				"LOG_LEVEL": "DEBUG",
				"REGIONAL_DB_CONN": "postgres://vetchium:vetchium_dev@regional-db-usa1:5432/vetchium_usa1?sslmode=disable",
				"SMTP_HOST": "mailpit",
				"SMTP_PORT": "1025",
				"SMTP_FROM_ADDRESS": "noreply@vetchium.com",
				"SMTP_FROM_NAME": "Vetchium",
				"EMAIL_WORKER_POLL_INTERVAL": "1s",
				"HUB_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"HUB_SESSION_CLEANUP_INTERVAL": "5s",
				"ORG_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"ORG_SESSION_CLEANUP_INTERVAL": "5s",
				"AGENCY_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"AGENCY_SESSION_CLEANUP_INTERVAL": "5s"
			}
		},
		"regional-worker-deu1": {
			"build": {
				"context": ".",
				"dockerfile": "api-server/Dockerfile.regional-worker"
			},
			"depends_on": {
				"migrate-deu1": {
					"condition": "service_completed_successfully"
				},
				"seed-deu1": {
					"condition": "service_completed_successfully"
				},
				"mailpit": {
					"condition": "service_started"
				}
			},
			"environment": {
				"REGION": "deu1",
				"LOG_LEVEL": "DEBUG",
				"REGIONAL_DB_CONN": "postgres://vetchium:vetchium_dev@regional-db-deu1:5432/vetchium_deu1?sslmode=disable",
				"SMTP_HOST": "mailpit",
				"SMTP_PORT": "1025",
				"SMTP_FROM_ADDRESS": "noreply@vetchium.com",
				"SMTP_FROM_NAME": "Vetchium",
				"EMAIL_WORKER_POLL_INTERVAL": "1s",
				"HUB_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"HUB_SESSION_CLEANUP_INTERVAL": "5s",
				"ORG_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"ORG_SESSION_CLEANUP_INTERVAL": "5s",
				"AGENCY_TFA_TOKEN_CLEANUP_INTERVAL": "5s",
				"AGENCY_SESSION_CLEANUP_INTERVAL": "5s"
			}
		},
		"api-lb": {
			"image": "nginx:alpine",
			"volumes": ["./nginx/api-lb.conf:/etc/nginx/nginx.conf:ro"],
			"ports": ["8080:80"],
			"depends_on": [
				"regional-api-server-ind1",
				"regional-api-server-usa1",
				"regional-api-server-deu1",
				"global-service"
			]
		}
	},
	"volumes": {
		"global-db-data": {},
		"regional-db-ind1-data": {},
		"regional-db-usa1-data": {},
		"regional-db-deu1-data": {}
	}
}
