#!/bin/sh

# Git pre-push hook managed by husky
# Checks prettier and goimports formatting before push

remote="$1"
url="$2"

z40=0000000000000000000000000000000000000000

# Read stdin to get push details
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$local_sha" = "$z40" ]; then
        # Handle delete
        continue
    fi

    # Determine commit range
    if [ "$remote_sha" = "$z40" ]; then
        # New branch, examine all commits
        range="$local_sha"
    else
        # Update to existing branch, examine new commits
        range="$remote_sha..$local_sha"
    fi

    # Get list of changed files
    changed_files=$(git diff --name-only --diff-filter=ACM "$range" 2>/dev/null || echo "")
    [ -z "$changed_files" ] && continue

    # Check prettier formatting (JS/TS/JSON/YAML/MD files)
    prettier_files=$(echo "$changed_files" | grep -E '\.(ts|tsx|js|jsx|json|ya?ml|md)$' || true)
    if [ -n "$prettier_files" ]; then
        echo "Checking prettier formatting..."

        # Filter to existing files only
        files_to_check=""
        for file in $prettier_files; do
            [ -f "$file" ] && files_to_check="$files_to_check $file"
        done

        if [ -n "$files_to_check" ]; then
            if command -v bunx >/dev/null 2>&1; then
                if ! bunx prettier --check $files_to_check; then
                    echo "❌ Prettier check failed!"
                    echo "Fix with: bun run format"
                    exit 1
                fi
            elif command -v npx >/dev/null 2>&1; then
                if ! npx prettier --check $files_to_check; then
                    echo "❌ Prettier check failed!"
                    echo "Fix with: npm run format"
                    exit 1
                fi
            else
                echo "⚠️  Warning: prettier not found, skipping check"
            fi
            echo "✓ Prettier check passed"
        fi
    fi

    # Check goimports formatting (Go files)
    go_files=$(echo "$changed_files" | grep -E '\.go$' || true)
    if [ -n "$go_files" ]; then
        echo "Checking goimports formatting..."

        if ! command -v goimports >/dev/null 2>&1; then
            echo "❌ goimports not found!"
            echo "Install it with: go install golang.org/x/tools/cmd/goimports@latest"
            exit 1
        fi

        failed_files=""
        for file in $go_files; do
            if [ -f "$file" ]; then
                tmp_file=$(mktemp)
                goimports "$file" > "$tmp_file"
                if ! diff -u "$file" "$tmp_file" >/dev/null 2>&1; then
                    failed_files="$failed_files $file"
                fi
                rm -f "$tmp_file"
            fi
        done

        if [ -n "$failed_files" ]; then
            echo "❌ goimports check failed for the following files:"
            for file in $failed_files; do
                echo "  $file"
            done
            echo "Fix with: bun run format"
            exit 1
        fi
        echo "✓ goimports check passed"
    fi
done

exit 0
